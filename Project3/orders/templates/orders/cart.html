{% extends "orders/base.html" %}

{% block body %}
<div class="container col-10">
	{% if message %}
	    <div class="alert alert-danger" role="alert">
	        {{ message }}
	    </div>
	{% endif %}
<form action="{% url 'orders:check_out' %}" method="post">
	{% csrf_token %}
	<table width="100%">
		<tbody>
			<tr>
				<td>Item</td>
				<td>Price</td>
			</tr>
				{% for item in shopping_cart_items %}
				<tr>
					<td name = "item">{{item.menu_item}}
					<ul>
					{% for add_on in item.get_add_ons_list %}
						<li>{{ add_on }}</li>
					{% endfor %}
					</ul>
					</td>
					<td><span class="order-item-price">{{item.final_price}}</span> <a href="" class="removeItem" id="{{item.id}}">[-]</a></td>
				</tr>
				{% endfor %}
				<tr>
					<td>Total: </td><td id="total-cost">{{shopping_cart.total_cost}}</td>
				</tr>
		</tbody>
	</table>


	<button class="btn btn-primary" type="submit" name="submit">Checkout</button>
</form>


</div>
<script type="text/javascript">
	document.addEventListener('DOMContentLoaded', () => {
		let total_cost = parseFloat(document.querySelector('#total-cost').innerHTML);

		document.querySelectorAll('.removeItem').forEach(remove => {
				remove.onclick = () => {
					const request = new XMLHttpRequest();

					//Get the id of the order item clicked
					const removeID = remove.id;


					//create a request to server with menu item route
					request.open('POST', '/removecartitem/');


					const data = new FormData();
					data.append('item_id', removeID);
					// Send request to update shopping cart server side
					request.setRequestHeader("X-CSRFToken", csrftoken);
					request.send(data);


					//update total cost on front end
					order_item_price = parseFloat(remove.parentElement.firstElementChild.innerHTML);
					total_cost = total_cost - order_item_price
					document.querySelector('#total-cost').innerHTML=`${total_cost.toFixed(2)}`;

					//remove table row
					table_row = remove.parentElement.parentElement;
					table = table_row.parentElement;
					table.removeChild(table_row);
					//stop page from reloading after request is sent
					return false;
				}
			});
	});
</script>
{% endblock %}
